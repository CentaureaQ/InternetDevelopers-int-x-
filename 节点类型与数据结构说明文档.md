# AppPlatform节点类型与数据结构说明文档

## 概述

AppPlatform工作流系统支持多种类型的节点，每种节点都有特定的功能和数据结构。本文档详细介绍了所有节点类型及其数据结构。

## 节点类型列表

1. 开始节点 (startNodeStart)
2. 结束节点 (endNodeEnd)
3. 大模型节点 (llmNodeState)
4. 条件节点 (conditionNodeCondition)
5. 知识检索节点 (knowledgeRetrievalNodeState)
6. 人工检查节点 (manualCheckNodeState)
7. FIT调用节点 (fitInvokeNodeState)
8. 代码节点 (codeNodeState)
9. 回复节点 (replyNodeState)
10. 变量聚合节点 (variableAggregationNodeState)
11. 变量更新节点 (variableUpdaterNodeState)
12. 循环节点 (loopNodeState)
13. 并行节点 (parallelNodeState)
14. 文本串联节点 (textConcatenationNodeState)
15. HTTP节点 (httpNodeState)
16. 工具调用节点 (toolInvokeNodeState)
17. 文件提取节点 (fileExtractionNodeState)
18. 文本提取节点 (textExtractionNodeState)
19. 文本转图片节点 (textToImageNodeState)
20. 问题分类节点 (questionClassificationNodeState)
21. 查询优化节点 (queryOptimizationNodeState)
22. 评估相关节点 (evaluationAlgorithmsNodeState, evaluationTestSetNodeState, evaluationStartNodeState, evaluationEndNodeState)
23. 智能表单节点 (intelligentFormNodeState)
24. HuggingFace节点 (huggingFaceNodeState)
25. 提取节点 (extractorNodeState)

## 节点详细数据结构

### 1. 开始节点 (startNodeStart)

```json
{
  "type": "startNodeStart",
  "container": "elsa-page:xxxxx",
  "id": "jade6qm5eg",
  "text": "开始",
  "namespace": "flowable",
  "x": -564.2261904761901,
  "y": -27.5,
  "width": 360,
  "height": 669,
  "flowMeta": {
    "triggerMode": "auto",
    "inputParams": [
      {
        "id": "91138f09-b635-43df-95c6-1fe3d1745829",
        "name": "input",
        "type": "Object",
        "from": "Expand",
        "config": [{"allowAdd": true}],
        "value": [
          {
            "id": "input_ae2ffd6e-2b9e-4e73-9d7f-0e661ec3dbdb",
            "name": "Question",
            "type": "String",
            "from": "Input",
            "description": "这是用户输入的问题",
            "value": "",
            "disableModifiable": true
          }
        ]
      },
      {
        "id": "4a770dc6-e3c9-475d-84c7-48dacc74a5b6",
        "name": "memory",
        "type": "Object",
        "from": "Expand",
        "value": [
          {
            "id": "cee9a31b-781c-4835-a616-ceed73be22a7",
            "name": "memorySwitch",
            "type": "Boolean",
            "from": "Input",
            "value": true
          },
          {
            "id": "cee9a31b-781c-4835-a616-ceed73be22f2",
            "name": "type",
            "type": "String",
            "from": "Input",
            "value": "ByConversationTurn"
          },
          {
            "id": "69592622-4291-409d-9d65-9faea83db657",
            "name": "value",
            "type": "Integer",
            "from": "Input",
            "value": "3"
          }
        ]
      }
    ]
  },
  "componentName": "startComponent",
  "runnable": true
}
```

### 2. 大模型节点 (llmNodeState)

```json
{
  "type": "llmNodeState",
  "container": "elsa-page:xxxxx",
  "id": "jadewdnjbq",
  "text": "大模型",
  "namespace": "flowable",
  "x": 434.14285714285734,
  "y": -64.88095238095246,
  "width": 360,
  "height": 840,
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "general_jober",
      "name": "",
      "fitables": ["modelengine.fit.jober.aipp.fitable.LLMComponent"],
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "6c414e75-971e-403a-b2b1-c6850f128cc4",
              "name": "model",
              "type": "String",
              "from": "Input",
              "value": "Qwen1.5-32B-Chat"
            },
            {
              "id": "db5fdafa-4cbf-44ba-9cca-8a98f1f77111",
              "name": "accessInfo",
              "type": "Object",
              "from": "Expand",
              "value": [
                {
                  "id": "db5fdafa-4cbf-44ba-9cca-8a98f1f77121",
                  "name": "serviceName",
                  "type": "String",
                  "from": "Input",
                  "value": "Fake Model"
                },
                {
                  "id": "db5fdafa-4cbf-44ba-9cca-8a98f1f77122",
                  "name": "tag",
                  "type": "String",
                  "from": "String",
                  "value": "INTERNAL"
                }
              ]
            },
            {
              "id": "db5fdafa-4cbf-44ba-9cca-8a98f1f771f4",
              "name": "temperature",
              "type": "Number",
              "from": "Input",
              "value": "0.3"
            },
            {
              "id": "88f74d78-4711-4f81-a2e7-74d0034c5e88",
              "name": "prompt",
              "type": "Object",
              "from": "Expand",
              "value": [
                {
                  "id": "35a710cf-1b79-4523-b16f-b50878d677fe",
                  "name": "template",
                  "type": "String",
                  "from": "Input",
                  "value": "请按照以下步骤生成您的回复：\n1. 递归地将问题分解为更小的问题。\n2. 对于每个原子问题，从上下文和对话历史记录中选择最相关的信息。\n3. 使用所选信息生成回复草稿。\n4. 删除回复草稿中的重复内容。\n5. 在调整后生成最终答案，以提高准确性和相关性。\n6. 请注意，只需要回复最终答案。\n-------------------------------------\n上下文信息：\n\n{{knowledge}}\n\n问题：{{query}}"
                },
                {
                  "id": "38fb27a1-71f4-4fcc-87d5-9d8a880bc04d",
                  "name": "variables",
                  "type": "Object",
                  "from": "Expand",
                  "value": [
                    {
                      "id": "aeba7823-8d14-4750-9723-55265ae71c4e",
                      "name": "knowledge",
                      "type": null,
                      "from": "Reference",
                      "value": [],
                      "referenceNode": "jade0pg2ag",
                      "referenceId": "5c9c6535-c127-445a-862a-966cf1083929",
                      "referenceKey": null
                    },
                    {
                      "id": "eee66922-4304-4209-89fc-b13ffa101630",
                      "name": "query",
                      "type": "String",
                      "from": "Reference",
                      "value": ["Question"],
                      "referenceKey": "Question",
                      "referenceNode": "jade6qm5eg",
                      "referenceId": "input_ae2ffd6e-2b9e-4e73-9d7f-0e661ec3dbdb"
                    }
                  ]
                }
              ]
            },
            {
              "id": "a6865419-867c-4bfb-855c-f5c1876c965a",
              "name": "tools",
              "type": "Array",
              "from": "Input",
              "value": []
            },
            {
              "id": "308e2023-a8e9-486e-9784-8680addbb786",
              "name": "workflows",
              "type": "Array",
              "from": "Input",
              "value": []
            },
            {
              "id": "68f92923-d5da-42ce-8478-d7ac7d90664e",
              "name": "systemPrompt",
              "type": "String",
              "from": "Input",
              "value": ""
            },
            {
              "id": "41b779fe-e522-4995-9b8e-fd772fb009e8",
              "name": "maxMemoryRounds",
              "type": "Integer",
              "from": "Input",
              "value": "0"
            },
            {
              "id": "eb53b8ca-ab64-4325-852a-1ff2842dbb95",
              "name": "enableLog",
              "type": "Boolean",
              "from": "Input",
              "value": false
            }
          ],
          "outputParams": [
            {
              "id": "95d84d67-3198-415e-a63c-bc9a2da8d821",
              "name": "output",
              "type": "Object",
              "from": "Expand",
              "value": [
                {
                  "id": "272c927a-9e25-48b6-a921-6a8ab20267a4",
                  "name": "llmOutput",
                  "type": "string",
                  "from": "Input",
                  "description": "",
                  "value": ""
                }
              ]
            }
          ]
        }
      },
      "isAsync": "true"
    },
    "joberFilter": {
      "type": "MINIMUM_SIZE_FILTER",
      "threshold": 1
    }
  },
  "componentName": "llmComponent",
  "runnable": true
}
```

### 3. 条件节点 (conditionNodeCondition)

```json
{
  "type": "conditionNodeCondition",
  "container": "elsa-page:xxxxx",
  "id": "jade62q33k",
  "text": "条件",
  "namespace": "flowable",
  "x": 876.6666666666667,
  "y": 59.166666666666686,
  "width": 600,
  "height": 360,
  "flowMeta": {
    "triggerMode": "auto",
    "joberFilter": {
      "type": "MINIMUM_SIZE_FILTER",
      "threshold": 1
    },
    "conditionParams": {
      "branches": [
        {
          "id": "9336682a-4ade-4583-ad77-7d995381e031",
          "conditionRelation": "and",
          "type": "if",
          "runnable": true,
          "conditions": [
            {
              "id": "89d7f0e6-2fa5-47f0-8917-e5e2cea63428",
              "condition": "equal",
              "value": [
                {
                  "id": "e36e4043-8cab-443d-9195-77ea3aa2d9a9",
                  "name": "left",
                  "type": "string",
                  "from": "Reference",
                  "value": ["output", "llmOutput"],
                  "referenceNode": "jadewdnjbq",
                  "referenceId": "272c927a-9e25-48b6-a921-6a8ab20267a4",
                  "referenceKey": "llmOutput"
                },
                {
                  "id": "dbdbf5d5-6e49-4f20-be3b-cfd75fff48b7",
                  "name": "right",
                  "type": "string",
                  "from": "Input",
                  "value": "123",
                  "referenceNode": "",
                  "referenceId": "",
                  "referenceKey": ""
                }
              ]
            }
          ]
        },
        {
          "id": "c1483791-c3ce-486c-ba54-6fe9d7b3ef3f",
          "conditionRelation": "and",
          "type": "else",
          "runnable": true,
          "conditions": [
            {
              "id": "fca67872-b0a7-423c-9014-6abf4784b0b6",
              "condition": "true",
              "value": []
            }
          ]
        }
      ]
    }
  },
  "componentName": "conditionComponent",
  "runnable": true
}
```

### 4. 知识检索节点 (knowledgeRetrievalNodeState)

```json
{
  "type": "knowledgeRetrievalNodeState",
  "id": "jade9b9ghd",
  "container": "elsa-page:xxxxx",
  "text": "知识检索",
  "namespace": "jadeFlow",
  "x": -83.33333333333326,
  "y": 113.33333333333331,
  "width": 360,
  "height": 494,
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "STORE_JOBER",
      "name": "",
      "fitables": [],
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "query_dfc65188-caf2-4e2a-b9a0-24985862298c",
              "name": "query",
              "type": "String",
              "from": "Reference",
              "referenceNode": "jade6qm5eg",
              "referenceId": "input_ae2ffd6e-2b9e-4e73-9d7f-0e661ec3dbdb",
              "referenceKey": "Question",
              "editable": false,
              "value": ["Question"]
            },
            {
              "id": "knowledge_edcf4873-5312-4554-9469-c5005572813c",
              "name": "knowledgeRepos",
              "type": "Array",
              "from": "Expand",
              "value": []
            },
            {
              "id": "retriever_option_e4b40b3d-9757-4346-8a90-cfb950d8f1e8",
              "name": "option",
              "type": "Object",
              "from": "Expand",
              "value": [
                {
                  "id": "03ce03b6-8d00-4fb0-bf32-85b2b40aaaee",
                  "from": "Expand",
                  "name": "indexType",
                  "type": "Object",
                  "value": [
                    {
                      "id": "543ff920-9927-48c6-bb65-cb1b97944b65",
                      "from": "Input",
                      "name": "type",
                      "type": "String",
                      "value": "semantic"
                    },
                    {
                      "id": "03d471a3-d4da-48a3-bbf8-d05bf06374e1",
                      "from": "Input",
                      "name": "name",
                      "type": "String",
                      "value": "语义检索"
                    },
                    {
                      "id": "647d0884-5539-4618-922e-af12b08d1d34",
                      "from": "Input",
                      "name": "description",
                      "type": "String",
                      "value": "基于文本的含义检索出最相关的内容"
                    }
                  ]
                },
                {
                  "id": "a6a619c8-eef0-4bfa-9e12-a8994edfb83f",
                  "name": "similarityThreshold",
                  "type": "Number",
                  "from": "Input",
                  "value": 0.5
                },
                {
                  "id": "c809934a-9023-48dc-a2c8-e33274ab7101",
                  "name": "referenceLimit",
                  "type": "Object",
                  "from": "Expand",
                  "value": [
                    {
                      "id": "369ad79e-397f-417c-b671-c4f714734693",
                      "name": "type",
                      "type": "String",
                      "from": "Input",
                      "value": "topK"
                    },
                    {
                      "id": "31071b92-7d9f-443b-930c-3329d05671f5",
                      "name": "value",
                      "type": "Integer",
                      "from": "Input",
                      "value": 3
                    }
                  ]
                },
                {
                  "id": "e45abef0-e276-42ea-832a-87e4a2aeb2be",
                  "name": "rerankParam",
                  "type": "Object",
                  "from": "Expand",
                  "value": [
                    {
                      "id": "5b737124-7de9-45b9-bff3-87c6b4d817e8",
                      "name": "enableRerank",
                      "type": "Boolean",
                      "from": "Input",
                      "value": false
                    }
                  ]
                }
              ]
            }
          ],
          "outputParams": [
            {
              "id": "output_f910d825-9382-40be-a250-2a218f64a58d",
              "name": "output",
              "type": "Array",
              "from": "Expand",
              "value": []
            }
          ]
        }
      },
      "entity": {
        "uniqueName": "70d1adbd-3421-4cb0-9231-fa357688b706",
        "params": [
          {
            "name": "query"
          },
          {
            "name": "knowledgeRepos"
          },
          {
            "name": "option"
          }
        ],
        "return": {
          "type": "object"
        }
      }
    },
    "joberFilter": {
      "type": "MINIMUM_SIZE_FILTER",
      "threshold": 1
    }
  },
  "componentName": "knowledgeRetrievalComponent",
  "runnable": true
}
```

### 5. 人工检查节点 (manualCheckNodeState)

```json
{
  "type": "manualCheckNodeState",
  "text": "智能表单",
  "componentName": "manualCheckComponent",
  "flowMeta": {
    "triggerMode": "manual",
    "task": {
      "formId": "form-id",
      "formVersion": "1.0",
      "enableStageDesc": true,
      "stageDesc": "请检查以下内容"
    }
  },
  "runnable": true
}
```

### 6. FIT调用节点 (fitInvokeNodeState)

```json
{
  "type": "fitInvokeNodeState",
  "text": "FIT调用",
  "width": 360,
  "backColor": "white",
  "pointerEvents": "auto",
  "componentName": "fitInvokeComponent",
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "GENERICABLE_JOBER",
      "fitables": ["fitable-id"],
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "param-id",
              "name": "param-name",
              "type": "String",
              "from": "Input|Reference",
              "value": "param-value"
            }
          ],
          "outputParams": [
            {
              "id": "output-id",
              "name": "output-name",
              "type": "Object",
              "from": "Expand",
              "value": []
            }
          ]
        }
      }
    }
  },
  "runnable": true
}
```

### 7. 并行节点 (parallelNodeState)

```json
{
  "type": "parallelNodeState",
  "text": "parallelNode",
  "componentName": "parallelComponent",
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "PARALLEL_JOBER",
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "input-id",
              "name": "input-name",
              "type": "Object",
              "from": "Expand",
              "value": []
            }
          ],
          "outputParams": [
            {
              "id": "output-id",
              "name": "output",
              "type": "Array",
              "from": "Expand",
              "value": []
            }
          ],
          "parallelCalls": [
            {
              "id": "call-id",
              "name": "call-name",
              "type": "Object",
              "from": "Expand",
              "value": []
            }
          ]
        }
      }
    }
  },
  "runnable": true
}
```

### 8. 循环节点 (loopNodeState)

```json
{
  "type": "loopNodeState",
  "text": "循环节点",
  "componentName": "loopComponent",
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "LOOP_JOBER",
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "input-id",
              "name": "list",
              "type": "Array",
              "from": "Reference",
              "value": []
            },
            {
              "id": "iteration-var-id",
              "name": "iterationVar",
              "type": "String",
              "from": "Input",
              "value": "item"
            },
            {
              "id": "max-iterations-id",
              "name": "maxIterations",
              "type": "Integer",
              "from": "Input",
              "value": "100"
            }
          ],
          "outputParams": [
            {
              "id": "output-id",
              "name": "results",
              "type": "Array",
              "from": "Expand",
              "value": []
            }
          ]
        }
      }
    }
  },
  "runnable": true
}
```

### 9. 变量聚合节点 (variableAggregationNodeState)

```json
{
  "type": "variableAggregationNodeState",
  "text": "变量聚合",
  "componentName": "variableAggregationComponent",
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "VARIABLE_AGGREGATION_JOBER",
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "input-id",
              "name": "variables",
              "type": "Array",
              "from": "Reference",
              "value": []
            },
            {
              "id": "operation-id",
              "name": "operation",
              "type": "String",
              "from": "Input",
              "value": "concat"
            }
          ],
          "outputParams": [
            {
              "id": "output-id",
              "name": "result",
              "type": "String",
              "from": "Expand",
              "value": ""
            }
          ]
        }
      }
    }
  },
  "runnable": true
}
```

### 10. 变量更新节点 (variableUpdaterNodeState)

```json
{
  "type": "variableUpdaterNodeState",
  "text": "变量更新",
  "componentName": "variableUpdaterComponent",
  "flowMeta": {
    "triggerMode": "auto",
    "jober": {
      "type": "VARIABLE_UPDATER_JOBER",
      "converter": {
        "type": "mapping_converter",
        "entity": {
          "inputParams": [
            {
              "id": "target-id",
              "name": "target",
              "type": "String",
              "from": "Reference",
              "value": []
            },
            {
              "id": "value-id",
              "name": "value",
              "type": "String",
              "from": "Reference|Input",
              "value": ""
            },
            {
              "id": "operation-id",
              "name": "operation",
              "type": "String",
              "from": "Input",
              "value": "set"
            }
          ],
          "outputParams": [
            {
              "id": "output-id",
              "name": "result",
              "type": "Object",
              "from": "Expand",
              "value": []
            }
          ]
        }
      }
    }
  },
  "runnable": true
}
```

## 通用字段说明

所有节点都包含以下通用字段：

- `type`: 节点类型，标识节点的功能
- `container`: 节点所属的容器ID
- `id`: 节点的唯一标识符
- `text`: 节点显示的文本
- `namespace`: 节点所属的命名空间
- `x`, `y`: 节点在画布上的坐标位置
- `width`, `height`: 节点的宽度和高度
- `flowMeta`: 节点的核心元数据和配置
- `componentName`: 节点对应的组件名称
- `runnable`: 节点是否可运行
- `dirty`: 节点是否有未保存的更改

## flowMeta 字段通用结构

`flowMeta` 是节点的核心配置，通常包含：

- `triggerMode`: 触发模式，可以是 "auto"（自动）或 "manual"（手动）
- `jober`: 工作执行器配置，包含节点执行的逻辑
  - `type`: 执行器类型
  - `fitables`: 执行器需要调用的服务或功能
  - `converter`: 数据转换器，用于处理输入和输出数据
    - `type`: 转换器类型，通常是 "mapping_converter"
    - `entity`: 转换器实体，包含输入参数和输出参数定义

## 节点连接

节点之间通过 "jadeEvent" 类型的连接线相连：

```json
{
  "type": "jadeEvent",
  "id": "jadey22z67",
  "container": "elsa-page:xxxxx",
  "text": "",
  "namespace": "elsa",
  "x": -204.22619047619014,
  "y": 307,
  "width": 120.89285714285688,
  "height": 53.333333333333314,
  "fromShape": "jade6qm5eg",
  "toShape": "jade9b9ghd",
  "definedFromConnector": "E",
  "definedToConnector": "W",
  "lineMode": {
    "type": "auto_curve"
  },
  "borderColor": "#B1B1B7",
  "runnable": true
}
```

## 数据引用

节点之间可以通过引用来传递数据：

```json
{
  "name": "variable-name",
  "type": "String",
  "from": "Reference",
  "value": ["output", "llmOutput"],
  "referenceNode": "jadewdnjbq",
  "referenceId": "272c927a-9e25-48b6-a921-6a8ab20267a4",
  "referenceKey": "llmOutput"
}
```

这允许一个节点引用另一个节点的输出作为其输入，实现数据流在节点之间的传递。