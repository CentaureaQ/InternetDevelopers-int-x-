# 工作流节点使用说明

本文档详细介绍了工作流系统中所有可用的工作节点及其使用方法。

## 1. 开始节点 (startNodeStart)

### 功能描述
工作流的起点节点，用于接收外部输入参数。

### 配置参数
无特殊配置参数。

### 输入参数
- 可自定义多个输入参数，通过工作流调试界面传入

### 输出参数
- 所有输入参数将直接传递给下游节点

### 使用示例
```json
{"input1": "value1", "input2": "value2"}
```

## 2. 知识检索节点 (knowledgeRetrievalNodeState)

### 功能描述
从知识库中检索相关信息，用于增强后续节点的处理能力。

### 配置参数
- `query`: 查询语句，支持引用变量 `{{inputs.query}}`
- `knowledgeBaseId`: 知识库ID
- `topK`: 返回结果数量，默认值为3
- `scoreThreshold`: 相似度阈值，默认值为0.5

### 输出参数
- `retrievedResults`: 检索到的知识库片段列表

### 使用示例
```json
{
  "query": "{{inputs.userQuery}}",
  "knowledgeBaseId": "123",
  "topK": 5,
  "scoreThreshold": 0.6
}
```

## 3. 文本拼接节点 (textConcatenationNodeState)

### 功能描述
将多个文本变量拼接成一个新的文本。

### 配置参数
- `texts`: 待拼接的文本列表，支持引用变量
- `separator`: 分隔符，默认值为""
- `textOutputKey`: 输出变量名，默认值为"text"

### 输出参数
- `{{textOutputKey}}`: 拼接后的文本

### 使用示例
```json
{
  "texts": ["Hello ", "{{inputs.userName}}", "!"],
  "separator": "",
  "textOutputKey": "greeting"
}
```

## 4. 变量聚合节点 (variableAggregationNodeState)

### 功能描述
将多个变量聚合到一个对象中。

### 配置参数
- `variables`: 变量列表，格式为 `[{"key": "var1", "value": "{{inputs.value1}}"}]`
- `textOutputKey`: 输出变量名，默认值为"result"

### 输出参数
- `{{textOutputKey}}`: 聚合后的对象

### 使用示例
```json
{
  "variables": [
    {"key": "name", "value": "{{inputs.userName}}"},
    {"key": "age", "value": "{{inputs.userAge}}"}
  ],
  "textOutputKey": "userInfo"
}
```

## 5. 变量更新节点 (variableUpdaterNodeState)

### 功能描述
更新或设置工作流中的变量。

### 配置参数
- `variables`: 变量更新列表，格式为 `[{"key": "var1", "value": "newValue"}]`

### 输出参数
- 更新后的变量将在整个工作流中可用

### 使用示例
```json
{
  "variables": [
    {"key": "counter", "value": "{{inputs.counter + 1}}"},
    {"key": "status", "value": "processed"}
  ]
}
```

## 6. LLM节点 (llmNodeState)

### 功能描述
调用大语言模型进行文本生成或对话。

### 配置参数
- `systemPrompt`: 系统提示词
- `userPrompt`: 用户提示词，支持引用变量
- `model`: 模型名称
- `temperature`: 温度参数，默认值为0.7
- `maxTokens`: 最大生成 tokens 数，默认值为1000
- `outputKey`: 输出变量名，默认值为"text"

### 输出参数
- `{{outputKey}}`: LLM生成的文本

### 使用示例
```json
{
  "systemPrompt": "你是一个助手",
  "userPrompt": "回答问题: {{inputs.question}}",
  "model": "gpt-4",
  "temperature": 0.5,
  "maxTokens": 500,
  "outputKey": "answer"
}
```

## 7. 条件节点 (conditionNodeCondition)

### 功能描述
根据条件判断选择不同的执行路径。

### 配置参数
- `conditionParams`: 条件参数列表，格式为 `[{"left": "{{inputs.value}}", "operator": "==", "right": "123"}]`
- `logic`: 逻辑运算符，支持"AND"或"OR"，默认值为"AND"

### 输出参数
- 无直接输出，根据条件结果选择执行路径

### 使用示例
```json
{
  "conditionParams": [
    {"left": "{{inputs.age}}", "operator": ">=", "right": "18"},
    {"left": "{{inputs.country}}", "operator": "==", "right": "China"}
  ],
  "logic": "AND"
}
```

## 8. HTTP请求节点 (httpNodeState)

### 功能描述
发送HTTP请求并处理响应。

### 配置参数
- `url`: 请求URL
- `method`: 请求方法，支持GET、POST、PUT、DELETE等
- `headers`: 请求头，格式为 `{"Content-Type": "application/json"}`
- `body`: 请求体，支持引用变量
- `outputKey`: 输出变量名，默认值为"httpResult"

### 输出参数
- `{{outputKey}}`: HTTP响应结果

### 使用示例
```json
{
  "url": "https://api.example.com/data",
  "method": "POST",
  "headers": {"Content-Type": "application/json"},
  "body": {"query": "{{inputs.query}}"},
  "outputKey": "apiResponse"
}
```

## 9. 代码节点 (codeNodeState)

### 功能描述
执行JavaScript代码，实现复杂的逻辑处理。

### 配置参数
- `code`: JavaScript代码，可访问inputs和vars变量
- `outputKey`: 输出变量名，默认值为"codeResult"

### 输出参数
- `{{outputKey}}`: 代码执行结果

### 使用示例
```javascript
// 计算两个数的和
const sum = inputs.a + inputs.b;
// 更新变量
vars.total = sum;
// 返回结果
return sum;
```

## 10. 循环节点 (loopNodeState)

### 功能描述
循环处理列表数据，支持遍历和条件循环。

### 配置参数
- `loopList`: 待循环的列表，支持引用变量
- `loopIterationVar`: 迭代变量名，默认值为"item"
- `maxIterations`: 最大迭代次数，默认值为100
- `outputKey`: 输出变量名，默认值为"loopResults"

### 输出参数
- `{{outputKey}}`: 循环执行结果列表

### 使用示例
```json
{
  "loopList": "{{inputs.userList}}",
  "loopIterationVar": "user",
  "maxIterations": 50,
  "outputKey": "processedUsers"
}
```

## 11. 并行节点 (parallelNodeState)

### 功能描述
并行执行多个子流程。

### 配置参数
- 无特殊配置参数，通过连线定义并行分支

### 输出参数
- `parallelResults`: 所有并行分支的结果列表

### 使用示例
无特殊配置，通过工作流连线配置并行分支。

## 12. 人工审核节点 (manualCheckNodeState)

### 功能描述
暂停工作流执行，等待人工审核通过后继续。

### 配置参数
- `reviewMessage`: 审核提示消息

### 输出参数
- `reviewResult`: 审核结果（"approved"或"rejected"）
- `reviewComments`: 审核评论

### 使用示例
```json
{
  "reviewMessage": "请审核生成的内容"
}
```

## 13. 回复节点 (replyNodeState)

### 功能描述
向用户返回工作流的最终结果。

### 配置参数
- `text`: 回复文本，支持引用变量

### 输出参数
- `replyText`: 回复文本

### 使用示例
```json
{
  "text": "处理完成，结果是: {{inputs.result}}"
}
```

## 14. 工具调用节点 (toolInvokeNodeState)

### 功能描述
调用外部工具或API。

### 配置参数
- `toolName`: 工具名称
- `toolParams`: 工具参数，支持引用变量
- `outputKey`: 输出变量名，默认值为"toolResult"

### 输出参数
- `{{outputKey}}`: 工具调用结果

### 使用示例
```json
{
  "toolName": "weatherTool",
  "toolParams": {"city": "{{inputs.city}}"},
  "outputKey": "weather"
}
```

## 15. 文本转图片节点 (textToImageNodeState)

### 功能描述
根据文本描述生成图片。

### 配置参数
- `prompt`: 图片描述，支持引用变量
- `model`: 模型名称
- `width`: 图片宽度，默认值为512
- `height`: 图片高度，默认值为512
- `numImages`: 生成图片数量，默认值为1
- `outputKey`: 输出变量名，默认值为"imageUrl"

### 输出参数
- `{{outputKey}}`: 生成的图片URL

### 使用示例
```json
{
  "prompt": "{{inputs.imageDescription}}",
  "model": "dall-e-3",
  "width": 1024,
  "height": 1024,
  "numImages": 2,
  "outputKey": "generatedImage"
}
```

## 16. 文件提取节点 (fileExtractionNodeState)

### 功能描述
从文件中提取内容。

### 配置参数
- `fileUrl`: 文件URL
- `extractionType`: 提取类型，支持"text"、"table"、"image"等
- `outputKey`: 输出变量名，默认值为"extractedContent"

### 输出参数
- `{{outputKey}}`: 提取的内容

### 使用示例
```json
{
  "fileUrl": "{{inputs.fileUrl}}",
  "extractionType": "text",
  "outputKey": "fileContent"
}
```

## 17. 问题分类节点 (questionClassificationNodeState)

### 功能描述
对用户问题进行分类。

### 配置参数
- `question`: 问题文本，支持引用变量
- `categories`: 分类列表，格式为 `["category1", "category2"]`
- `outputKey`: 输出变量名，默认值为"category"

### 输出参数
- `{{outputKey}}`: 分类结果

### 使用示例
```json
{
  "question": "{{inputs.userQuestion}}",
  "categories": ["技术问题", "业务咨询", "投诉建议"],
  "outputKey": "questionCategory"
}
```

## 18. 查询优化节点 (queryOptimizationNodeState)

### 功能描述
优化用户查询，提高检索效果。

### 配置参数
- `query`: 原始查询，支持引用变量
- `optimizationType`: 优化类型，支持"expansion"、"refinement"等
- `outputKey`: 输出变量名，默认值为"optimizedQuery"

### 输出参数
- `{{outputKey}}`: 优化后的查询

### 使用示例
```json
{
  "query": "{{inputs.userQuery}}",
  "optimizationType": "expansion",
  "outputKey": "betterQuery"
}
```

## 19. 文本提取节点 (textExtractionNodeState)

### 功能描述
从文本中提取特定信息。

### 配置参数
- `text`: 待提取的文本，支持引用变量
- `extractionPatterns`: 提取模式列表，格式为 `[{"key": "name", "pattern": "Name: (.*)"}]`
- `outputKey`: 输出变量名，默认值为"extractedInfo"

### 输出参数
- `{{outputKey}}`: 提取的信息对象

### 使用示例
```json
{
  "text": "{{inputs.document}}",
  "extractionPatterns": [
    {"key": "email", "pattern": "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"},
    {"key": "phone", "pattern": "\\d{11}"}
  ],
  "outputKey": "contactInfo"
}
```

## 20. 评估算法节点 (evaluationAlgorithmsNodeState)

### 功能描述
对模型输出或系统结果进行评估。

### 配置参数
- `evaluationType`: 评估类型，支持"accuracy"、"relevance"、"fluency"等
- `reference`: 参考标准，支持引用变量
- `prediction`: 预测结果，支持引用变量
- `outputKey`: 输出变量名，默认值为"evaluationResult"

### 输出参数
- `{{outputKey}}`: 评估结果

### 使用示例
```json
{
  "evaluationType": "relevance",
  "reference": "{{inputs.correctAnswer}}",
  "prediction": "{{inputs.modelOutput}}",
  "outputKey": "relevanceScore"
}
```

## 21. 评估测试集节点 (evaluationTestSetNodeState)

### 功能描述
使用测试集评估模型性能。

### 配置参数
- `testSetId`: 测试集ID
- `modelId`: 模型ID
- `evaluationMetrics`: 评估指标列表，默认值为["accuracy", "f1"]
- `outputKey`: 输出变量名，默认值为"testSetResults"

### 输出参数
- `{{outputKey}}`: 测试集评估结果

### 使用示例
```json
{
  "testSetId": "456",
  "modelId": "789",
  "evaluationMetrics": ["accuracy", "precision", "recall"],
  "outputKey": "modelPerformance"
}
```

## 22. 评估开始节点 (evaluationStartNodeState)

### 功能描述
评估流程的开始节点。

### 配置参数
- `evaluationName`: 评估名称
- `evaluationDescription`: 评估描述

### 输出参数
- 无直接输出

### 使用示例
```json
{
  "evaluationName": "模型性能评估",
  "evaluationDescription": "评估模型在测试集上的表现"
}
```

## 23. 评估结束节点 (evaluationEndNodeState)

### 功能描述
评估流程的结束节点。

### 配置参数
- 无特殊配置参数

### 输出参数
- `evaluationSummary`: 评估总结

### 使用示例
无特殊配置。

## 24. 智能表单节点 (intelligentFormNodeState)

### 功能描述
生成智能表单或处理表单数据。

### 配置参数
- `formSchema`: 表单 schema，格式为 JSON Schema
- `formData`: 表单数据，支持引用变量
- `outputKey`: 输出变量名，默认值为"formResult"

### 输出参数
- `{{outputKey}}`: 表单处理结果

### 使用示例
```json
{
  "formSchema": {
    "type": "object",
    "properties": {
      "name": {"type": "string"},
      "age": {"type": "number"}
    },
    "required": ["name"]
  },
  "formData": "{{inputs.userData}}",
  "outputKey": "validatedForm"
}
```

## 25. 提取器节点 (extractorNodeState)

### 功能描述
从结构化数据中提取特定字段。

### 配置参数
- `data`: 待提取的数据，支持引用变量
- `extractFields`: 待提取的字段列表，格式为 `["field1", "field2.subfield"]`
- `outputKey`: 输出变量名，默认值为"extractedData"

### 输出参数
- `{{outputKey}}`: 提取的数据对象

### 使用示例
```json
{
  "data": "{{inputs.complexObject}}",
  "extractFields": ["name", "contact.email", "contact.phone"],
  "outputKey": "userInfo"
}
```

## 26. 结束节点 (endNodeEnd)

### 功能描述
工作流的终点节点。

### 配置参数
无特殊配置参数。

### 输出参数
- 将工作流最终结果返回给调用者

### 使用示例
无特殊配置。

## 循环节点使用说明

### 基本概念
循环节点用于对列表数据进行批量处理，每次迭代会将列表中的一个元素传递给子流程。

### 使用步骤
1. 添加循环节点到工作流
2. 配置循环列表：可以是固定列表 `["item1", "item2"]` 或引用变量 `{{inputs.items}}`
3. 配置迭代变量名：默认值为"item"，子流程中可通过 `{{inputs.item}}` 访问当前元素
4. 连接子流程：从循环节点的"循环"端口连接到需要重复执行的节点
5. 连接完成路径：从子流程的结束节点连接回循环节点的"完成"端口
6. 配置最大迭代次数：防止无限循环

### 循环执行流程
1. 循环节点接收列表数据
2. 对列表中的每个元素：
   - 将元素赋值给迭代变量
   - 执行子流程
   - 收集子流程的输出结果
3. 所有元素处理完成后，将结果列表传递给下游节点

### 注意事项
- 子流程必须有明确的结束点并连接回循环节点
- 设置合理的最大迭代次数，避免无限循环
- 循环过程中产生的变量不会影响外部变量

### 高级用法
- 嵌套循环：可以在子流程中再次使用循环节点
- 条件循环：结合条件节点实现满足特定条件时退出循环
- 动态列表：循环列表可以是其他节点生成的动态结果

## 变量引用语法

在所有支持变量的配置字段中，可以使用以下语法引用变量：

- 引用输入参数：`{{inputs.variableName}}`
- 引用上游节点输出：`{{nodeId.outputKey}}`
- 引用工作流变量：`{{vars.variableName}}`
- 简单表达式：`{{inputs.a + inputs.b}}`

## 工作流调试

1. 保存工作流后，点击"调试"按钮
2. 输入工作流输入参数
3. 点击"开始调试"
4. 查看每个节点的执行结果和输出
5. 根据调试结果调整节点配置

## 最佳实践

1. **节点职责单一**：每个节点只负责一个功能
2. **变量命名规范**：使用清晰、有意义的变量名
3. **添加注释**：为复杂逻辑添加说明
4. **设置合理的超时时间**：防止单个节点阻塞整个工作流
5. **测试小粒度功能**：先测试单个节点，再测试整个工作流
6. **使用条件节点处理异常情况**：增加工作流的健壮性
7. **定期备份工作流**：防止配置丢失

## 常见问题

### Q: 工作流执行失败怎么办？
A: 查看节点执行日志，检查配置参数和变量引用是否正确。

### Q: 如何处理大量数据？
A: 使用循环节点批量处理，设置合理的批处理大小。

### Q: 如何实现错误重试？
A: 可以结合条件节点和循环节点实现简单的重试逻辑。

### Q: 如何监控工作流执行状态？
A: 通过工作流管理界面查看执行历史和状态。

---

本文档基于当前后端功能编写，如有功能更新请参考最新版本。